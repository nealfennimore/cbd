var Candle = function(candle, el_index){
        this.candle_img = getRandomInt(0,candle);
        this.container_index = getRandomInt(1,el_index)
    }



var Cake = {

  candles: [],

  createCandles: function(age){
    for (var i = 0; i < age; i++) {
      var candle = new Candle(5,5);
      this.candles.push(candle);
    }
  },

  createCandleHolder: function(candle_index){
    var holder = document.createElement("div");
    holder.setAttribute('id', 'candle-' + candle_index )

    var candle_container_index = Cake.candles[candle_index].container_index,
        candle_parent = document.getElementsByClassName("candle-holder-" + candle_container_index)[0],
        candle_parent_child_holder = candle_parent.children[0];

    if (candle_parent_child_holder.children.length === 0) {
      holder.style.zIndex = 0;
    };

    holder = this.setCandleHolderOffsetFromParent(holder, candle_container_index, candle_parent);
    this.setCandleHolderZindex(holder, candle_parent_child_holder);

    return holder;
  },

  setCandleHolderOffsetFromParent: function(holder, candle_container_index, candle_parent){
    var random_offset = getRandomInt(0, candle_parent.offsetHeight);

    if (candle_container_index === 3 || candle_container_index === 4) {
      var top = 95;
    } else {
      var top = 39;
    }
    var left = getRandomInt(0, candle_parent.offsetWidth) - 23;

    holder.style.top = "-" + (random_offset + top) + 'px';
    holder.style.left = left + 'px';
    return holder;
  },

  setCandleHolderZindex: function(holder, parent_el){

    var zindex = holder.style.zIndex;
    parent_el.appendChild(holder);

    var current_top = parseInt(holder.style.top.slice(0,-2));
    var siblings = parent_el.childNodes;

    for(var i = 0; i < siblings.length; i++) {
      var current_sibling_top = parseInt(siblings[i].style.top.slice(0,-2));
      var current_sibling_zindex = parseInt(siblings[i].style.zIndex) || 0;



      if(current_sibling_top >= current_top && current_sibling_zindex <= zindex){
          holder.style.zIndex = current_sibling_zindex - 1;
      } 
    };

  },

  createCandleFlameHolder: function(i){
      var flame = document.createElement("div");
      flame.setAttribute('id', 'flame-' + i)
      flame.setAttribute('class', 'flame');    
      return flame;
  },

  renderCandleFlame: function(flame_holder_index){
      var flame_svg = "<%= asset_path('cake-candle.svg') %>"
      var s = Snap("#flame-" + flame_holder_index);
      Snap.load(flame_svg, function(data){
        s.append( data );
      });
  },

  renderCandles: function(){
    for (var i = 0; i < this.candles.length; i++) {

      (function() {

      var candle_holder = Cake.createCandleHolder(i);
      var flame_holder = Cake.createCandleFlameHolder(i);
      candle_holder.appendChild(flame_holder);

      var s = Snap("#candle-" + i);
      var candle_svg = Cake.grabCandleSVGImg[Cake.candles[i].candle_img];
    
      Snap.load(candle_svg, function(data){
        s.append( data );
      });

      Cake.renderCandleFlame(i);

      })(i);
    }
  },

  grabCandleSVGImg: [
  "<%= asset_path('candle-0.svg') %>",
  "<%= asset_path('candle-1.svg') %>",
  "<%= asset_path('candle-2.svg') %>",
  "<%= asset_path('candle-3.svg') %>",
  "<%= asset_path('candle-4.svg') %>"
  ],

};



function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

Cake.createCandles(27);
Cake.renderCandles();

$(document).ready(function(){
  $('div.flame').hover(function(){
    $(this).fadeOut(150);
  })
})



